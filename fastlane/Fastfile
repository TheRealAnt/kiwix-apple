# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

platform :ios do
  desc "Build iOS app without codesigning"
  lane :devbuild do
    ci_settings
    build_app(scheme: "Kiwix",
              destination: "generic/platform=iOS",
              sdk: 'iphoneos',
              skip_codesigning: true)
            end

  desc "Build iOS app for AppStore"
  lane :build do
    ci_settings
    build_app(
      destination: "generic/platform=iOS",
      sdk: 'iphoneos',
      configuration: 'Release',
      allowProvisioningUpdates: true,
      export_options: {
        method: "app-store",
        authenticationKeyPath: ENV['APP_STORE_CONNECT_API_KEY_KEY_FILEPATH'],
        authenticationKeyID: ENV['APP_STORE_CONNECT_API_KEY_KEY_ID'],
        authenticationKeyIssuerID: ENV['APP_STORE_CONNECT_API_KEY_ISSUER_ID'],
      }
    )
  end

  desc "Build iOS app for AppStore, manual signing"
  lane :build_manual do
    ci_settings
    match_appstore_certificates
    if is_ci
      unlock_keychain(
        path: "/Users/runner/Library/Keychains/fastlane_tmp_keychain-db",
        password: "my_temp_secret"
      )
    end
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "Kiwix.xcodeproj",
      profile_name: "match AppStore self.Kiwix"
    )
    build_app(
      destination: "generic/platform=iOS",
      sdk: 'iphoneos',
      configuration: 'Release',
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "self.Kiwix": "match AppStore self.Kiwix",
        },
        allowProvisioningUpdates: true,
        authenticationKeyPath: ENV['APP_STORE_CONNECT_API_KEY_KEY_FILEPATH'],
        authenticationKeyID: ENV['APP_STORE_CONNECT_API_KEY_KEY_ID'],
        authenticationKeyIssuerID: ENV['APP_STORE_CONNECT_API_KEY_ISSUER_ID'],
        signingStyle: 'manual',
      }
    )
  end
end


platform :mac do
  desc "Build macOS app without codesigning"
  lane :devbuild do
    build_app(scheme: "Kiwix",
              destination: "generic/platform=macOS",
              skip_codesigning: true)
  end

  desc "Build macOS app for AppStore"
  lane :build do
    ci_settings
    match_appstore_certificates
    build_app(scheme: "Kiwix",
              destination: "generic/platform=macOS",
              export_options: {
        method: "app-store",
        provisioningProfiles: {
          "self.Kiwix": "match AppStore self.Kiwix",
        },
        signingStyle: 'manual',
      })
  end
end

private_lane :ci_settings do
  if is_ci
    setup_ci
    xcode_select "/Applications/Xcode_15.0.1.app"
  end
end

private_lane :match_appstore_certificates do
  if is_ci
    match(type: "appstore", readonly: true, git_url: "./certificates")
  else
    match(type: "appstore", readonly: true)
  end
end